<!DOCTYPE HTML>
<html>
<head>
	<title>fake generals</title>
	<meta charset="utf-8">
	<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="main.css">
</head>
<body onmousewheel="bbimg()" style="
    width: calc(100vw);
    height: calc(100vh);
    margin: 0;">
	<a href="https://github.com/juruocjl/fake-generals" target="_blank" class="ribbons">
		<img loading="lazy" width="149" height="149" src="forkme_right_darkblue_121621.png" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1">
	</a>
	<div class="index">
		<div class="contain">
		<input id="name" class="name"></input><br>
		<button id="replay">回放</button>
		</div>
	</div>
	<div class="turn">turn <span id="turn">?</span></div>
	<div class="rank">
	<table><tbody id="rank">
		<tr>
			<th>rank</th>
			<th>name</th>
			<th>army</th>
			<th>land</th>
		</tr>
	</tbody></table>
	</div>
	<div class="control"><div class="pre">Pre</div><div class="next">Next</div></div>
	<table cellspacing="0" cellpadding="0" border="0">
		 <tbody class="map"  style="display:none;">
		 </tbody>
	</table>
	<script>
	function showname(name,rating){
		if(rating<1200)return '<span class="newbiw">'+name+'</span>';
		if(rating<1400)return '<span class="pupil">'+name+'</span>';
		if(rating<1600)return '<span class="specialist">'+name+'</span>';
		if(rating<1900)return '<span class="expert">'+name+'</span>';
		if(rating<2100)return '<span class="candidate-master">'+name+'</span>';
		if(rating<2400)return '<span class="master">'+name+'</span>';
		if(rating<3000)return '<span class="grandmaster">'+name+'</span>';
		return '<span class="legendary-grandmaster">'+name+'</span>';
	}
    document.body.onselectstart=document.body.oncontextmenu=function(){return false;};
	var drag = document.querySelector(".map");
	drag.onmousedown = function(e1) {
		var x1 = e1.clientX;
		var y1 = e1.clientY;
		var l1 = this.offsetLeft;
		var t1 = this.offsetTop;
		window.onmousemove = function(e2) {
			var x2 = e2.clientX;
			var y2 = e2.clientY;
			var l2 = l1 + (x2 - x1);
			var t2 = t1 + (y2 - y1);
			drag.style.left = l2 + 'px';
			drag.style.top = t2 + 'px';
		}
	}
	drag.onmouseup = function() {
		window.onmousemove = null;
	}
	var now = 30;
	function bbimg() {
		now += event.wheelDelta / 40;
		now = Math.max(26, now);
		now = Math.min(50, now);
		$(".cell").css('height', now + 'px');
		$(".cell").css('width', now + 'px');
		$(".map").css('font-size',Math.min(18,Math.floor((now+32)/4))+'px');
	}
	const color=["red","blue","green","purple","brown","orange","pink"];
	var userlist;
	var n,m;
	var maps=[];
	var everyadd;
	var rank=[];
	var turn=0;
	function pred(Map,val,add){
		Map=JSON.parse(JSON.stringify(Map));
		if(!add)
			return Map;
		for(var i=0;i<n;i++)
			for(var j=0;j<m;j++){
				if(Map[i][j][0]>=0&&Map[i][j][1]>=0){
					if(Map[i][j][0]==0)Map[i][j][2]+=val;
					else if(Map[i][j][0]!=4)Map[i][j][2]++;
					else{
						Map[i][j][2]--;
						if(Map[i][j][2]==0)Map[i][j][1]=-1;
					}
				}
			}
		return Map;
	}
	function showrk(){
		var arr=[];
		for(var i=0;i<userlist.length;i++)
			if(userlist[i].vip==0)
				arr[i]={'name':showname(userlist[i].name,userlist[i].rating),'color':color[i],'army':rank[i][0],'land':rank[i][1]};
			else
				arr[i]={'name':showname(userlist[i].name,userlist[i].rating)+'<i class="vip'+userlist[i].vip+'"></i>','color':color[i],'army':rank[i][0],'land':rank[i][1]};
		arr.sort((a,b)=>{
			if(a.army!=b.army)return b.army-a.army;
			if(a.land!=b.land)return b.land-a.land;
			return a.color<b.color?1:-1;
		});
		for(var i=0;i<userlist.length;i++)
			$('#rank >tr[data='+i+']').html('<td style="color:white;background:'+arr[i].color+';font-weight:800;">'+(i+1)+'</td><td>'+arr[i].name+'</td><td>'+arr[i].army+'</td><td>'+arr[i].land+'</td>')
	}
	function show(map){
		for(var i=0;i<userlist.length;i++)rank[i]=[0,0];
		for(var i=0;i<n;i++)for(var j=0;j<m;j++)if(map[i][j][0]>=0&&map[i][j][1]>=0){
			rank[map[i][j][1]][1]++;
			rank[map[i][j][1]][0]+=map[i][j][2];
		}
		showrk();
		for(var i=0;i<n;i++){
			var line = $('.map >tr[data='+i+']')
			for(var j=0;j<m;j++){
				var now=line.children('td')[j];
				var inner;
				if(map[i][j][0]==-2){
					now.style.background="#565656";
					inner="<span class='num'></span>";
				}else if(map[i][j][0]==-3){
					now.style.background="#565656";
					inner="<span class='unknow num'></span>";
				}else{
					if(map[i][j][0]==-1){
						now.style.background="#b3b3b3";
						inner="<span class='mountain num visible'></span>";
					}else if(map[i][j][0]==0){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#d7d7d7";
						if(map[i][j][2])inner="<span class='empty num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='empty num visible'></span>";;
					}else if(map[i][j][0]==1){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='town num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='town num visible'></span>";;
					}else if(map[i][j][0]==2){
						now.style.background=color[map[i][j][1]];
						if(map[i][j][2])inner="<span class='crown num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='crown num visible'></span>";
					}else if(map[i][j][0]==3){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='umbrella num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='umbrella num visible'></span>";
					}else if(map[i][j][0]==4){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='water num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='water num visible'></span>";
					}
				}
				if(now.innerHTML!=inner)now.innerHTML=inner;
			}
		}
	};
	function getQueryVariable(variable)
	{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
	}
	if(getQueryVariable('name'))$('#name').val(getQueryVariable('name'));
	$('#replay').click(()=>{
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.open("GET", 'getfile?name='+$('#name').val(), false );
		xmlHttp.send();
		if(xmlHttp.responseText=="Not Found")alert('Not Found');
		else{
			var data=JSON.parse(xmlHttp.responseText);
			console.log(data);
			$('.index').css('display','none');
			$('.ribbons').css('display','none');
			n=data.his[0].length;
			m=data.his[0][0].length;
			userlist=data.users;
			var cnt=data.his.length;
			maps[0]=data.his[0];
			everyadd=data.everyadd;
			for(var i=1;i<data.his.length;i++){
				maps[i]=pred(maps[i-1],(i+1)%everyadd==0,(data.ver>=2)?i%2==1:true);
				data.his[i].forEach((x)=>{maps[i][x[0]][x[1]]=x[2];});
			}
			for(var i=0;i<n;i++)
				$('.map').append('<tr data="'+i+'" class="line"></tr>');
			for(var j=0;j<m;j++)
				$('.map > tr').append('<td class="cell"></td>')
			document.querySelector(".map").style.display='table';
			for(var i=0;i<n;i++){
				var line = $('.map >tr[data='+i+']')
				for(var j=0;j<m;j++)
					var now=line.children('td')[j];
			}
			for(var i=0;i<userlist.length;i++)
				$('#rank').append('<tr data="'+i+'"></tr>')
			show(maps[0]);
			$('.pre').click(()=>{
				if(turn>0)turn--,show(maps[turn]),$('#turn').text(data.ver>=2?Math.ceil(turn/2):turn);
			});
			$('.next').click(()=>{
				if(turn+1<maps.length)turn++,show(maps[turn]),$('#turn').text(data.ver>=2?Math.ceil(turn/2):turn);
				else alert('end');
			})
			document.onkeydown=function(event){
			   var e = event || window.event || arguments.callee.caller.arguments[0];
			   if(e && e.keyCode==65)if(turn>0)turn--,show(maps[turn]),$('#turn').text(data.ver>=2?Math.ceil(turn/2):turn);
			   if(e && e.keyCode==68){
				  if(turn+1<maps.length)turn++,show(maps[turn]),$('#turn').text(data.ver>=2?Math.ceil(turn/2):turn);
				  else alert('end');
			   }
		   };
		}
    });
	</script>
</body>

</html>
