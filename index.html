<!DOCTYPE HTML>
<html>
<head>
	<title>fake generals</title>
	<meta charset="utf-8">
	<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>
<body onmousewheel="bbimg()" style="
    width: calc(100vw);
    height: calc(100vh);
    margin: 0;">
	<style>
	body{user-select: none;}
	.map{position: fixed;left:50%;top:50%;transform: translate(-50%, -50%);color:white;font-size:18px;font-weight:800;white-space: nowrap;}
	.contain{position: fixed;left:50%;top:50%;transform:translate(-50%, -50%);text-align:center;}
	.name{width:150px;height:30px;border:1px solid #ccc;padding:14px;border-radius:16px;font-size:20px;margin:10px;}
	.cell{position: relative;height:30px;width:30px;text-align:center;display:inline-block;}
	.index{height:100%;width:100%;}
	.num{display:flex;align-items:center;justify-content:center;}
	.crown{right:0;top:0;position: absolute;width: 100%;height: 100%;background:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMyA0MkgzNUw0MSAyMUwzMSAyNkwyNCAxMkwxNyAyNkw3IDIxTDEzIDQyWiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjciIGN5PSIxOCIgcj0iMyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiLz48Y2lyY2xlIGN4PSIyNCIgY3k9IjkiIHI9IjMiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0Ii8+PGNpcmNsZSBjeD0iNDEiIGN5PSIxOCIgcj0iMyIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiLz48L3N2Zz4=");background-size:cover;}
	.left {top: 20%;left: -1%;height: 60%;width: 20%;z-index: 40;position: absolute;background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik01Ljc5ODg5IDI0SDQxLjc5ODkiIHN0cm9rZT0iI2YwZWJlYiIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMTcuNzk4OCAzNkw1Ljc5ODgzIDI0TDE3Ljc5ODggMTIiIHN0cm9rZT0iI2YwZWJlYiIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=");background-size: cover;}
	.right {top: 20%;right: -1%;height: 60%;width: 20%;z-index: 40;position: absolute;background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik00MS45OTk5IDI0SDUuOTk5OTQiIHN0cm9rZT0iI2YwZWJlYiIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMzAgMTJMNDIgMjRMMzAgMzYiIHN0cm9rZT0iI2YwZWJlYiIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=");background-size: cover;background-position: right;}
	.up {top: -1%;left: 20%;height: 20%;width: 60%;z-index: 40;position: absolute;background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0yNCA2VjQyIiBzdHJva2U9IiNmMGViZWIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTEyIDE4TDI0IDZMMzYgMTgiIHN0cm9rZT0iI2YwZWJlYiIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=");background-size: cover;}
	.down {bottom: -1%;left: 20%;height: 20%;width: 60%;z-index: 40;position: absolute;background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0yNCA0MlY2IiBzdHJva2U9IiNmMGViZWIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTM2IDMwTDI0IDQyTDEyIDMwIiBzdHJva2U9IiNmMGViZWIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+");background-size: cover;background-position: bottom;}
	.mountain{right:0;top:0;position: absolute;width: 100%;height: 100%;background:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xOCAxMEwzMiAzOEg0TDE4IDEwWiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMjggMjlMMzMuNjQ3MSAyMkw0NCAzOEgzMiIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMiAyMkwyNCAyMiIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xNCAxOEwxMCAyNiIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0yMiAxOEwyNiAyNiIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==");background-size:cover;}
	.town{right:0;top:0;position: absolute;width: 100%;height: 100%;background:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNiAyOEg4QzYuODk1NDMgMjggNiAyOC44OTU0IDYgMzBWNDQiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTMyIDI4SDQwQzQxLjEwNDYgMjggNDIgMjguODk1NCA0MiAzMFY0NCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMTkuOTk5NCAyNEgyNy45OTk0QzI3Ljk5OTQgMjQgMzMuMTY1MiAxOC4zMjE1IDMxLjk5OTQgMTVDMzEuMjQ0NiAxMi44NDk0IDI5LjU2MTUgMTEuNjU5NyAyNy45OTk0IDEwQzI2LjQzNzMgOC4zNDAyNyAyMy45OTk0IDYgMjMuOTk5NCA2QzIzLjk5OTQgNiAyMS41NjE1IDguMzQwMjcgMTkuOTk5NCAxMEMxOC40MzczIDExLjY1OTcgMTYuNzU0MiAxMi44NDk0IDE1Ljk5OTQgMTVDMTQuODMzNyAxOC4zMjE1IDE5Ljk5OTQgMjQgMTkuOTk5NCAyNFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTQgNDRINDQiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMTYgMjRIMjRIMzJWNDRIMTZWMjRaIiBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTI0IDM0VjQ0IiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTTI0IDRWNyIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMCAyNFYyOCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxwYXRoIGQ9Ik0zOCAyNFYyOCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxwYXRoIGQ9Ik0yMCA0NEwyOCA0NCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==");background-size:cover;}
	.unknow{right:0;top:0;position: absolute;width: 100%;height: 100%;background:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNCAxNEwzNCAzNCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xNCAzNEwzNCAxNCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==");background-size:cover;}
	.empty{right:0;top:0;position: absolute;width: 100%;height: 100%;}
	.umbrella{right:0;top:0;position: absolute;width: 100%;height: 100%;background:url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDQ4IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNC4zNDA5IDIxLjQxMTlMMjQuMDAwMiAyNC4wMDAxTDMzLjY1OTQgMjYuNTg4M0w0My4zMTg3IDI5LjE3NjVDNDUuNjU2NyAyMC40NTA2IDQxLjg0NzYgMTEuNTI1OSAzNC41NDU5IDcuMDAwMTJDMzIuOTE5NiA1Ljk5MjExIDMxLjEyIDUuMjAyMzIgMjkuMTc2NSA0LjY4MTU2QzI2LjkzODMgNC4wODE4MyAyNC42ODY5IDMuODg2NTYgMjIuNTAwMSA0LjA1MDk1QzE0LjI2MjggNC42NzAxOCA2Ljk0MDc0IDEwLjM5MjYgNC42ODE2NCAxOC44MjM3TDE0LjM0MDkgMjEuNDExOVoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNMjkuMTc2MiA0LjY4MTRDMjkuMTc2MiA0LjY4MTQgMjMuNTM1NSA4LjM0NjM0IDIwLjMwOTUgMTIuNjU4M0MxNy4wODM2IDE2Ljk3MDMgMTYuMjcyNSAyMS45Mjk0IDE2LjI3MjUgMjEuOTI5NCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0yOS4xNzY4IDQuNjgxNEMyOS4xNzY4IDQuNjgxNCAzMi4yMjkzIDEwLjY3NTcgMzIuODY3MSAxNi4wMjNDMzMuNTA0OCAyMS4zNzAyIDMxLjcyNzggMjYuMDcwNSAzMS43Mjc4IDI2LjA3MDUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48cGF0aCBkPSJNNC42ODE2NCAxOC44MjM3TDE0LjM0MDkgMjEuNDExOUwyNC4wMDAyIDI0LjAwMDFMMzMuNjU5NCAyNi41ODgzTDQzLjMxODcgMjkuMTc2NSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik00IDQ0SDQ0IiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PHBhdGggZD0iTTI0IDI0TDE4LjUgNDMuOTk5OSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0yMi41IDQuMDUwOTVDMjQuNjg2OCAzLjg4NjU2IDI2LjkzODIgNC4wODE4MyAyOS4xNzY0IDQuNjgxNTZDMzEuMTE5OSA1LjIwMjMyIDMyLjkxOTUgNS45OTIxMSAzNC41NDU4IDcuMDAwMTIiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=");background-size:cover;}
	.visible{box-shadow: black 0px 0px 0px 1px;box-sizing: border-box;}
	.nowpos{box-shadow: white 0px 0px 0px 3px;box-sizing: border-box;z-index:10;}
	.turn{position:fixed;top:0;left:0;padding:10px;border: 1px solid black;z-index:20;background:white;}
	.rank{position:fixed;top:0;right:0;border: 1px solid black;z-index:20;background:white;}
	.gameend{position:fixed;top:50%;left:50%;transform: translate(-50%, -50%);background:white;padding:20px;text-align:center;z-index:40;}
	.ribbons{position: fixed;top: 0px;right: 0px;z-index: 50;}
	</style>
	<a href="https://github.com/juruocjl/fake-generals" target="_blank" class="ribbons">
		<img loading="lazy" width="149" height="149" src="forkme_right_darkblue_121621.png" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1">
	</a>
	<div class="index">
		<div class="contain">
		<div id="name" class="name"></div>
		<button id="start">Start!</button>
		<div>当前在线：<span id="online">?</span>人</div>
		</div>
	</div>
	<div class="gameend" style="display:none">
	</div>
	<div class="turn">turn <span id="turn">?</span></div>
	<div class="rank">
	<table><tbody id="rank">
		<tr>
			<th>rank</th>
			<th>name</th>
			<th>army</th>
			<th>land</th>
		</tr>
	</tbody></table>
	</div>
	<table cellspacing="0" cellpadding="0" border="0">
		 <tbody class="map"  style="display:none;">
		 </tbody>
	</table>
	<script>
    document.body.onselectstart=document.body.oncontextmenu=function(){return false;};
	var drag = document.querySelector(".map");
	drag.onmousedown = function(e1) {
		var x1 = e1.clientX;
		var y1 = e1.clientY;
		var l1 = this.offsetLeft;
		var t1 = this.offsetTop;
		window.onmousemove = function(e2) {
			var x2 = e2.clientX;
			var y2 = e2.clientY;
			var l2 = l1 + (x2 - x1);
			var t2 = t1 + (y2 - y1);
			drag.style.left = l2 + 'px';
			drag.style.top = t2 + 'px';
		}
	}
	drag.onmouseup = function() {
		window.onmousemove = null;
	}
	var now = 30;
	function bbimg() {
		now += event.wheelDelta / 40;
		now = Math.max(26, now);
		now = Math.min(50, now);
		$(".cell").css('height', now + 'px');
		$(".cell").css('width', now + 'px');
		$(".map").css('font-size',Math.min(18,Math.floor((now+32)/4))+'px');
	}
	function setCookie(cname, cvalue) {
		var d = new Date();
		d.setTime(d.getTime() + (114514 * 24 * 60 * 60 * 1000));
		var expires = "expires=" + d.toGMTString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
	}
	function getCookie(cname) {
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i].trim();
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}
	var user = getCookie("username");
	while (user == "") {
		user = prompt("请输入你的名字:", "");
		if (user.length > 15) {
			alert('最多只能15个字符');
			user = "";
		} else if (!user.match(/^[a-z]+$/gi)) {
			alert('只能使用小写英文字母');
			user = "";
		} else setCookie("username", user);
	}
	$('#name').text(user);
	var ws = new WebSocket("ws://"+location.hostname+":3000");
	$('#start').click(() => {
		ws.send(JSON.stringify({
			'typ': 'startgame'
		}));
	});
	var uid=-1;
	const base="`~!@#$%^&*()_+qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM[];',./{}|:<>?";
	var id=[];for(var i=0;i<base.length;i++)id[base[i]]=i;
	class Deque {
		constructor() {this.items = [];this.count = 0;this.lowestCount = 0;}
		addBack(element) {this.items[this.count] = element;this.count++;};
		popFront(){return this.items[this.lowestCount++];};
		popBack() {return this.items[--this.count];};
		size(){return this.count-this.lowestCount;}
		clear(){this.count=this.lowestCount=0;}
		to_string(){var a="";for(var i=this.lowestCount;i<this.count;i++){a+=this.items[i].length;for(var j=0;j<this.items[i].length;j++)a+=base[this.items[i][j]];}return a;}
		from_string(a){this.clear();for(i=0;i<a.length;){var l=parseInt(a[i]);var tmp=[];i++;for(var j=0;j<l;i++,j++)tmp[j]=id[a[i]];this.addBack(tmp);}}
	to_array(){var a=[];for(var i=this.lowestCount;i<this.count;i++)a[i-this.lowestCount]=this.items[i];return a;}
	};
	Q = new Deque();
	const color=["red","blue","green","purple","brown","orange","pink"];
	var userlist;
	var n,m;
	var nowx=-1,nowy=-1,op=0;
	var map=[];
	var vis=[];
	function pred(Map,val){
		for(var i=0;i<n;i++)
			for(var j=0;j<m;j++){
				if(Map[i][j][0]>=0&&Map[i][j][1]>=0){
					Map[i][j][2]+=val;
					if(Map[i][j][0]>0)Map[i][j][2]++;
				}
			}
		return Map;
	}
	function show(){
		for(var i=0;i<n;i++)for(var j=0;j<m;j++)for(var k=0;k<4;k++)vis[i][j][k]=false;
		Q.to_array().forEach((x)=>{if(x.length==3)vis[x[0]][x[1]][x[2]]=true;});
		for(var i=0;i<n;i++){
			var line = $('.map >tr[data='+i+']')
			for(var j=0;j<m;j++){
				var now=line.children('td')[j];
				var inner;
				if(map[i][j][0]==-2){
					now.style.background="#565656";
					inner="<span class='num'></span>";
				}else if(map[i][j][0]==-3){
					now.style.background="#565656";
					inner="<span class='unknow num'></span>";
				}else{
					if(map[i][j][0]==-1){
						now.style.background="#b3b3b3";
						inner="<span class='mountain num visible'></span>";
					}else if(map[i][j][0]==0){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#d7d7d7";
						if(map[i][j][2])inner="<span class='empty num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='empty num visible'></span>";;
					}else if(map[i][j][0]==1){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='town num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='town num visible'></span>";;
					}else if(map[i][j][0]==2){
						now.style.background=color[map[i][j][1]];
						if(map[i][j][2])inner="<span class='crown num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='crown num visible'></span>";
					}else if(map[i][j][0]==3){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='umbrella num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='umbrella num visible'></span>";
					}
				}
				if(vis[i][j][0])inner+="<span class='up'></span>";
				if(vis[i][j][1])inner+="<span class='down'></span>";
				if(vis[i][j][2])inner+="<span class='left'></span>";
				if(vis[i][j][3])inner+="<span class='right'></span>";
				if(now.innerHTML!=inner)now.innerHTML=inner;
				if(i==nowx&&j==nowy){
					now.classList.add("nowpos");
					if(op)console.log(now),now.firstChild.innerHTML="50%";
				}
				else now.classList.remove("nowpos");
			}
		}
	};
	function showrk(rank){
		var arr=[];
		for(var i=0;i<userlist.length;i++)
			arr[i]={'name':userlist[i],'color':color[i],'army':rank[i][0],'land':rank[i][1]};
		arr.sort((a,b)=>{
			if(a.army!=b.army)return b.army-a.army;
			if(a.land!=b.land)return b.land-a.land;
			return a.color<b.color?1:-1;
		});
		for(var i=0;i<userlist.length;i++)
			$('#rank >tr[data='+i+']').html('<td>'+(i+1)+'</td><td style="color:white;background:'+arr[i].color+'">'+arr[i].name+'</td><td>'+arr[i].army+'</td><td>'+arr[i].land+'</td>')
	}
	function setnow(a,b){
		//console.log(nowx,nowy,op,a,b);
		if(nowx!=-1&&nowy!=-1&&Math.abs(nowx-a)+Math.abs(nowy-b)==1){
			var d;
			if(a==nowx-1)d=0;
			if(a==nowx+1)d=1;
			if(b==nowy-1)d=2;
			if(b==nowy+1)d=3;
			Q.addBack([nowx,nowy,d]);
			ws.send(JSON.stringify({'typ':'add queue','uid':uid,'data':[nowx,nowy,op*4+d]}))
			nowx=a,nowy=b,op=0;
		}else if(nowx==a&&nowy==b){
			if(op==0)op=1;
			else op=0,nowx=-1,nowy=-1;
			console.log(op);
		}else if(nowx>=0&&nowy>=0&&map[nowx][nowy][0]==3){
			Q.addBack([nowx,nowy,a,b,op]);
			ws.send(JSON.stringify({'typ':'add queue','uid':uid,'data':[nowx,nowy,a,b,op]}))
			nowx=a,nowy=b,op=0;
		}else nowx=a,nowy=b,op=0;
		show();
	}
	document.onkeydown=function(event){
       var e = event || window.event || arguments.callee.caller.arguments[0];
       if(e && e.keyCode==32)nowx=nowy=-1,show();
       if(e && e.keyCode==87)if(nowx!=-1&&nowx>0)setnow(nowx-1,nowy);
       if(e && e.keyCode==83)if(nowx!=-1&&nowx+1<n)setnow(nowx+1,nowy);
       if(e && e.keyCode==65)if(nowy!=-1&&nowy>0)setnow(nowx,nowy-1);
       if(e && e.keyCode==68)if(nowy!=-1&&nowy+1<m)setnow(nowx,nowy+1);
       if(e && e.keyCode==69){
		    if(Q.size()){
				lst=Q.popBack();
				nowx=lst[0];
				nowy=lst[1];
				show();
				ws.send(JSON.stringify({'typ':'pop queue','uid':uid}));
			}
	   }if(e && e.keyCode==81){
		    if(Q.size()){
				Q.clear();
				show();
				ws.send(JSON.stringify({'typ':'clear queue','uid':uid}));
			}
	   }if(e && e.keyCode==27){
			$('.gameend').css('display','block');
			$('.gameend').html('是否投降<br><br><button id="okok">确定</button> <button id="bxbx">取消</button>');
			$('#okok').click(()=>{$('.gameend').css('display','none');ws.send(JSON.stringify({'typ':'surrender','uid':uid}))});
			$('#bxbx').click(()=>{$('.gameend').css('display','none');});
	   }
    };
	ws.onmessage = (evt)=>{
		var data = JSON.parse(evt.data);
		if (data.typ == 'already start'){
			alert('已经开始，请关闭页面');
			location.href=location.href;
		}
		if (data.typ == 'start'){
			ws.send(JSON.stringify({
				'typ': 'get uid',
				'name': user
			}));
			$(".index").css('display','none');
			$(".ribbons").css('display','none');
		}
		if (data.typ == 'uid') {
			uid = data.uid;
			console.log('您的uid是', uid);
		}
		if(data.typ=='first map'){
			userlist = data.users;
			n=data.n;
			m=data.m;
			for(var i=0;i<n;i++)
				$('.map').append('<tr data="'+i+'" class="line"></tr>');
			for(var j=0;j<m;j++)
				$('.map > tr').append('<td class="cell"></td>')
			document.querySelector(".map").style.display='table';
			for(var i=0;i<n;i++){
				var line = $('.map >tr[data='+i+']')
				vis[i]=[];
				map[i]=[];
				for(var j=0;j<m;j++){
					var now=line.children('td')[j];
					(()=>{
						var a=i,b=j;
						now.onmousedown=(e)=>{
							if(e.button==0&&map[a][b][0]!=-1)
								setnow(a,b);
						}
					})();
					vis[i][j]=[0,0,0,0];
					map[i][j]=[-2];
					if(data.firstmap[i*m+j]=="1")
						map[i][j]=[-3];
				}
			}
			for(var i=0;i<userlist.length;i++)
				$('#rank').append('<tr data="'+i+'"></tr>')
		}
		if(data.typ=='new turn'){
			ws.send(JSON.stringify({
				'typ': 'get map',
				'uid': uid
			}));
			$('#turn').text(data.turn);
		}
		if(data.typ=='map'){
			map=pred(map,data.val);
			//console.log(data.diff);
			for(var i=0;i<data.diff.length;i++)
				map[data.diff[i][0]][data.diff[i][1]]=data.diff[i][2];
			Q.from_string(data.queue);
			show();
			showrk(data.rank);
		}
		if(data.typ=='new connection'){
			$('#online').text(data.cnt);
		}
		if(data.typ=='end'){
			ws.close();
			map=data.lstmap;
			show();
			showrk(data.lstrank);
			$('.gameend').css('display','block');
			$('.gameend').html('最后的胜利者是 '+userlist[data.winner]+'<br><br><button id="okok">ok</button>');
			$('#okok').click(()=>{$('.gameend').css('display','none');});
		}
	};
	</script>
</body>

</html>
