<!DOCTYPE HTML>
<html>
<head>
	<title>fake generals</title>
	<meta charset="utf-8">
	<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="main.css">
</head>
<body onmousewheel="bbimg()" style="
    width: calc(100vw);
    height: calc(100vh);
    margin: 0;">
	<a href="https://github.com/juruocjl/fake-generals" target="_blank" class="ribbons">
		<img loading="lazy" width="149" height="149" src="forkme_right_darkblue_121621.png" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1">
	</a>
	<div class="index">
		<div class="contain">
		<div id="name" class="name"></div>
		<div>当前rating为<span id="rating"></span></div><br>
		<button id="start">Start!</button>
		<div>当前在线：<span id="online">?</span>人</div>
		<input type="radio" name="gametype" value="ffa" id="ffa">FFA(rated)<br>
		<input type="radio" name="gametype" value="sb" id="sb">伞兵大战<br>
		<input type="radio" name="gametype" value="dark" id="dark">浓雾模式
		</div>
	</div>
	<div class="gameend" style="display:none">
	</div>
	<div class="turn">turn <span id="turn">?</span></div>
	<div class="rank">
	<table><tbody id="rank">
		<tr>
			<th>rank</th>
			<th>name</th>
			<th>army</th>
			<th>land</th>
		</tr>
	</tbody></table>
	</div>
	<div class="toolcontain">
		<div class="outer" id="showsearch">
			<div class="search"></div>
		</div><br>
		<div class="outer" id="showinfo">
			<div class="infos"></div>
		</div><br>
		<div class="outer" id="showdrank">
			<div class="donationrk"></div>
		</div><br>
		<div class="outer" id="showrank">
			<div class="ranking"></div>
		</div>
	</div>
	<div class="notice">
		
	</div>
	<table cellspacing="0" cellpadding="0" border="0">
		 <tbody class="map"  style="display:none;">
		 </tbody>
	</table>
	<script>
	var nowwin="none";
	$('#showrank').click(()=>{
		if(nowwin!="rank"){
			$('.notice').css('display','block');
			$('.notice').html('<iframe src="ratingrk" style="width:100%;height:100%;"></iframe>')
			nowwin="rank";
		}else $('.notice').css('display','none'),nowwin="none";
	});
	$('#showdrank').click(()=>{
		if(nowwin!="drank"){
			$('.notice').css('display','block');
			$('.notice').html('<iframe src="donationrk" style="width:100%;height:100%;"></iframe>')
			nowwin="drank";
		}else $('.notice').css('display','none'),nowwin="none";
	});
	$('#showinfo').click(()=>{
		if(nowwin!="info"){
			$('.notice').css('display','block');
			$('.notice').html('<iframe src="infos" style="width:100%;height:100%;"></iframe>')
			nowwin="info";
		}else $('.notice').css('display','none'),nowwin="none";
	});
	$('#showsearch').click(()=>{
		if(nowwin!="search"){
			$('.notice').css('display','block');
			$('.notice').html('<iframe src="qry?name=0" style="width:100%;height:100%;"></iframe>')
			nowwin="search";
		}else $('.notice').css('display','none'),nowwin="none";
	});
	function showname(name,rating){
		if(rating<1200)return '<span class="newbiw">'+name+'</span>';
		if(rating<1400)return '<span class="pupil">'+name+'</span>';
		if(rating<1600)return '<span class="specialist">'+name+'</span>';
		if(rating<1900)return '<span class="expert">'+name+'</span>';
		if(rating<2100)return '<span class="candidate-master">'+name+'</span>';
		if(rating<2400)return '<span class="master">'+name+'</span>';
		if(rating<3000)return '<span class="grandmaster">'+name+'</span>';
		return '<span class="legendary-grandmaster">'+name+'</span>';
	}
    document.body.onselectstart=document.body.oncontextmenu=function(){return false;};
	var drag = document.querySelector(".map");
	drag.onmousedown = function(e1) {
		var x1 = e1.clientX;
		var y1 = e1.clientY;
		var l1 = this.offsetLeft;
		var t1 = this.offsetTop;
		window.onmousemove = function(e2) {
			var x2 = e2.clientX;
			var y2 = e2.clientY;
			var l2 = l1 + (x2 - x1);
			var t2 = t1 + (y2 - y1);
			drag.style.left = l2 + 'px';
			drag.style.top = t2 + 'px';
		}
	}
	drag.onmouseup = function() {
		window.onmousemove = null;
	}
	var now = 30;
	function bbimg() {
		now += event.wheelDelta / 40;
		now = Math.max(26, now);
		now = Math.min(50, now);
		$(".cell").css('height', now + 'px');
		$(".cell").css('width', now + 'px');
		$(".map").css('font-size',Math.min(18,Math.floor((now+32)/4))+'px');
	}
	function setCookie(cname, cvalue) {
		var d = new Date();
		d.setTime(d.getTime() + (114514 * 24 * 60 * 60 * 1000));
		var expires = "expires=" + d.toGMTString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
	}
	function getCookie(cname) {
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i].trim();
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}
	var user = decodeURIComponent(getCookie("username"));
	var vip = getCookie("vip");
	var rating = getCookie("rating");
	$('#name').html(showname(user,rating)+'<i class="vip'+vip+'"></i>');
	$('#rating').html(showname(rating,rating));
	var ws = new WebSocket("ws://"+location.hostname+":3000");
	$('input[type=radio][name=gametype]').change(()=>{
		var gametype = $('input:radio[name="gametype"]:checked').val();
		console.log(gametype);
		ws.send(JSON.stringify({'typ':'type change','type':gametype}));
	})
	$('#start').click(() => {ws.send(JSON.stringify({'typ': 'startgame'}));});
	const base="`~!@#$%^&*()_+qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM[];',./{}|:<>?";
	var id=[];for(var i=0;i<base.length;i++)id[base[i]]=i;
	class Deque {
		constructor() {this.items = [];this.count = 0;this.lowestCount = 0;}
		addBack(element) {this.items[this.count] = element;this.count++;};
		popFront(){return this.items[this.lowestCount++];};
		popBack() {return this.items[--this.count];};
		size(){return this.count-this.lowestCount;}
		clear(){this.count=this.lowestCount=0;}
		to_string(){var a="";for(var i=this.lowestCount;i<this.count;i++){a+=this.items[i].length;for(var j=0;j<this.items[i].length;j++)a+=base[this.items[i][j]];}return a;}
		from_string(a){this.clear();for(i=0;i<a.length;){var l=parseInt(a[i]);var tmp=[];i++;for(var j=0;j<l;i++,j++)tmp[j]=id[a[i]];this.addBack(tmp);}}
		to_array(){var a=[];for(var i=this.lowestCount;i<this.count;i++)a[i-this.lowestCount]=this.items[i];return a;}
	};
	Q = new Deque();
	const color=["red","blue","green","purple","brown","orange","pink"];
	var userlist;
	var n,m;
	var nowx=-1,nowy=-1,op=0;
	var map=[];
	var vis=[];
	var notinit=true;
	function pred(Map,val){
		for(var i=0;i<n;i++)
			for(var j=0;j<m;j++){
				if(Map[i][j][0]>=0&&Map[i][j][1]>=0){
					if(Map[i][j][0]==0)Map[i][j][2]+=val;
					else Map[i][j][2]++;
				}
			}
	}
	function show(){
		for(var i=0;i<n;i++)for(var j=0;j<m;j++)for(var k=0;k<4;k++)vis[i][j][k]=false;
		Q.to_array().forEach((x)=>{if(x.length==3)vis[x[0]][x[1]][x[2]]=true;});
		for(var i=0;i<n;i++){
			var line = $('.map >tr[data='+i+']')
			for(var j=0;j<m;j++){
				var now=line.children('td')[j];
				var inner;
				if(map[i][j][0]==-2){
					now.style.background="#565656";
					inner="<span class='num'></span>";
				}else if(map[i][j][0]==-3){
					now.style.background="#565656";
					inner="<span class='unknow num'></span>";
				}else{
					if(map[i][j][0]==-1){
						now.style.background="#b3b3b3";
						inner="<span class='mountain num visible'></span>";
					}else if(map[i][j][0]==0){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#d7d7d7";
						if(map[i][j][2])inner="<span class='empty num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='empty num visible'></span>";;
					}else if(map[i][j][0]==1){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='town num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='town num visible'></span>";;
					}else if(map[i][j][0]==2){
						now.style.background=color[map[i][j][1]];
						if(map[i][j][2])inner="<span class='crown num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='crown num visible'></span>";
					}else if(map[i][j][0]==3){
						if(map[i][j][1]>=0)now.style.background=color[map[i][j][1]];
						else now.style.background="#757575";
						if(map[i][j][2])inner="<span class='umbrella num visible'>"+map[i][j][2]+"</span>";
						else inner="<span class='umbrella num visible'></span>";
					}
				}
				if(vis[i][j][0])inner+="<span class='up'></span>";
				if(vis[i][j][1])inner+="<span class='down'></span>";
				if(vis[i][j][2])inner+="<span class='left'></span>";
				if(vis[i][j][3])inner+="<span class='right'></span>";
				if(now.innerHTML!=inner)now.innerHTML=inner;
				if(i==nowx&&j==nowy){
					now.classList.add("nowpos");
					if(op)now.firstChild.innerHTML="50%";
				}
				else now.classList.remove("nowpos");
			}
		}
	};
	function showrk(rank){
		var arr=[];
		for(var i=0;i<userlist.length;i++)
			if(userlist[i].vip==0)
				arr[i]={'name':showname(userlist[i].name,userlist[i].rating),'color':color[i],'army':rank[i][0],'land':rank[i][1]};
			else
				arr[i]={'name':showname(userlist[i].name,userlist[i].rating)+'<i class="vip'+userlist[i].vip+'"></i>','color':color[i],'army':rank[i][0],'land':rank[i][1]};
		arr.sort((a,b)=>{
			if(a.army!=b.army)return b.army-a.army;
			if(a.land!=b.land)return b.land-a.land;
			return a.color<b.color?1:-1;
		});
		for(var i=0;i<userlist.length;i++)
			$('#rank >tr[data='+i+']').html('<td style="color:white;background:'+arr[i].color+';font-weight:800;">'+(i+1)+'</td><td>'+arr[i].name+'</td><td>'+arr[i].army+'</td><td>'+arr[i].land+'</td>')
	}
	function setnow(a,b){
		if(nowx!=-1&&nowy!=-1&&Math.abs(nowx-a)+Math.abs(nowy-b)==1){
			var d;
			if(a==nowx-1)d=0;
			if(a==nowx+1)d=1;
			if(b==nowy-1)d=2;
			if(b==nowy+1)d=3;
			Q.addBack([nowx,nowy,d]);
			ws.send(JSON.stringify({'typ':'add queue','data':[nowx,nowy,op*4+d]}))
			nowx=a,nowy=b,op=0;
		}else if(nowx==a&&nowy==b){
			if(op==0)op=1;
			else op=0,nowx=-1,nowy=-1;
			console.log(op);
		}else if(nowx>=0&&nowy>=0&&map[nowx][nowy][0]==3){
			Q.addBack([nowx,nowy,a,b,op]);
			ws.send(JSON.stringify({'typ':'add queue','data':[nowx,nowy,a,b,op]}))
			nowx=a,nowy=b,op=0;
		}else nowx=a,nowy=b,op=0;
		show();
	}
	document.onkeydown=function(event){
       var e = event || window.event || arguments.callee.caller.arguments[0];
       if(e && e.keyCode==32)nowx=nowy=-1,show();
       if(e && e.keyCode==87)if(nowx!=-1&&nowx>0)setnow(nowx-1,nowy);
       if(e && e.keyCode==83)if(nowx!=-1&&nowx+1<n)setnow(nowx+1,nowy);
       if(e && e.keyCode==65)if(nowy!=-1&&nowy>0)setnow(nowx,nowy-1);
       if(e && e.keyCode==68)if(nowy!=-1&&nowy+1<m)setnow(nowx,nowy+1);
       if(e && e.keyCode==69){
		    if(Q.size()){
				lst=Q.popBack();
				nowx=lst[0];
				nowy=lst[1];
				show();
				ws.send(JSON.stringify({'typ':'pop queue'}));
			}
	   }if(e && e.keyCode==81){
		    if(Q.size()){
				Q.clear();
				show();
				ws.send(JSON.stringify({'typ':'clear queue'}));
			}
	   }if(e && e.keyCode==88){
			var ums=[];
			for(var i=0;i<n;i++)for(var j=0;j<m;j++)if(map[i][j][0]==3)
				ums[ums.length]=[i,j];
			ums.sort((a,b)=>{return map[b[0]][b[1]][2]-map[a[0]][a[1]][2];});
			var tmpx=nowx,tmpy=nowy;
			for(var i=0;i<ums.length;i++)
				nowx=ums[i][0],nowy=ums[i][1],
				setnow(tmpx,tmpy);
	   }if(e && e.keyCode==27){
			$('.gameend').css('display','block');
			$('.gameend').html('是否投降<br><br><button id="okok">确定</button> <button id="bxbx">取消</button>');
			$('#okok').click(()=>{$('.gameend').css('display','none');ws.send(JSON.stringify({'typ':'surrender'}))});
			$('#bxbx').click(()=>{$('.gameend').css('display','none');});
	   }
    };
	ws.onmessage = (evt)=>{
		var data = JSON.parse(evt.data);
		if (data.typ == 'already start'){
			userlist = data.users;
			n=data.n;
			m=data.m;
			for(var i=0;i<n;i++)
				$('.map').append('<tr data="'+i+'" class="line"></tr>');
			for(var j=0;j<m;j++)
				$('.map > tr').append('<td class="cell"></td>')
			document.querySelector(".map").style.display='table';
			for(var i=0;i<n;i++){
				var line = $('.map >tr[data='+i+']')
				vis[i]=[];
				map[i]=[];
				for(var j=0;j<m;j++){
					var now=line.children('td')[j];
					(()=>{
						var a=i,b=j;
						now.onmousedown=(e)=>{
							if(e.button==0&&map[a][b][0]!=-1)
								setnow(a,b);
						}
					})();
					vis[i][j]=[0,0,0,0];
					map[i][j]=[-2];
				}
			}
			for(var i=0;i<userlist.length;i++)
				$('#rank').append('<tr data="'+i+'"></tr>')
			$(".index").css('display','none');
			$(".ribbons").css('display','none');
			$(".notice").css('display','none');
			$(".toolcontain").css('display','none');
		}
		if (data.typ == 'start'){
			ws.send(JSON.stringify({
				'typ': 'join game',
				'name': user
			}));
			$(".index").css('display','none');
			$(".ribbons").css('display','none');
			$(".notice").css('display','none');
			$(".toolcontain").css('display','none');
		}
		if(data.typ=="type change"){
			document.getElementById(data.type).checked=true;
		}
		if(data.typ=='init game'){
			userlist = data.users;
			n=data.n;
			m=data.m;
			notinit=false;
			for(var i=0;i<n;i++)
				$('.map').append('<tr data="'+i+'" class="line"></tr>');
			for(var j=0;j<m;j++)
				$('.map > tr').append('<td class="cell"></td>')
			document.querySelector(".map").style.display='table';
			for(var i=0;i<n;i++){
				var line = $('.map >tr[data='+i+']')
				vis[i]=[];
				map[i]=[];
				for(var j=0;j<m;j++){
					var now=line.children('td')[j];
					(()=>{
						var a=i,b=j;
						now.onmousedown=(e)=>{
							if(e.button==0&&map[a][b][0]!=-1)
								setnow(a,b);
						}
					})();
					vis[i][j]=[0,0,0,0];
					map[i][j]=[-2];
					if(data.firstmap[i*m+j]=="1")
						map[i][j]=[-3];
				}
			}
			for(var i=0;i<userlist.length;i++)
				$('#rank').append('<tr data="'+i+'"></tr>')
		}
		if(data.typ=='new turn'){
			if(notinit)ws.send(JSON.stringify({'typ': 'get map','full':true}));
			else ws.send(JSON.stringify({'typ': 'get map','full':false}));
			$('#turn').text(data.turn);
			showrk(data.rank);
		}
		if(data.typ=='map'){
			if(!data.full){
				pred(map,data.val);
				for(var i=0;i<data.diff.length;i++)
					map[data.diff[i][0]][data.diff[i][1]]=data.diff[i][2];
			}else map=data.map,notinit=false;
			Q.from_string(data.queue);
			show();
		}
		if(data.typ=='new connection'){
			$('#online').text(data.cnt);
		}
		if(data.typ=='end'){
			ws.close();
			map=data.lstmap;
			show();
			showrk(data.lstrank);
			$('.gameend').css('display','block');
			$('.gameend').html('<iframe src="qry?name='+data.name+'" style="height:400px;"></iframe><button id="okok">ok</button>');
			$('#okok').click(()=>{$('.gameend').css('display','none');});
		}
	};
	</script>
</body>

</html>
